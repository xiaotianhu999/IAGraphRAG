# aiplusall-kb 知识库改造技术规范 - 需求文档

## 项目概述

aiplusall-kb 知识库改造项目旨在将现有的单一租户隔离知识库系统升级为支持多层次共享的企业级知识管理平台，特别针对法律领域进行专业化优化，实现"语义检索+知识图谱+web search+LLM"的融合架构，确保回答准确度接近100%。

## 术语表

- **KnowledgeBase（知识库）**: 知识的容器，支持不同的所有权和可见性模型
- **Knowledge（知识文档）**: 知识库中的具体文档，包含内容和元数据
- **ResourceTenant（资源租户）**: 承载存储、检索引擎等资源的租户
- **OwnerType（所有者类型）**: system（系统）、tenant（租户）、user（用户）
- **Visibility（可见性）**: private（私有）、shared（共享）、public（公开）
- **LegalMetadata（法律元数据）**: 法律文档的专业化元数据信息

## 核心需求

### 需求 1: 多层次权限模型

**用户故事**: 作为企业用户，我希望能够创建不同层次的知识库，支持全租户共享、租户私有、用户私有和灵活分享，以满足不同的协作需求。

#### 验收标准

1. WHEN 系统管理员创建全租户共享知识库 THEN 系统应将其设置为 OwnerType=system, Visibility=public，所有租户用户可读
2. WHEN 租户管理员创建租户私有知识库 THEN 系统应将其设置为 OwnerType=tenant, Visibility=private，仅该租户成员可见
3. WHEN 普通用户创建用户私有知识库 THEN 系统应将其设置为 OwnerType=user, Visibility=private，仅创建者可见
4. WHEN 用户分享私有知识库给他人 THEN 系统应创建分享记录，支持 read/write/admin 权限级别
5. WHEN 分享设置过期时间 THEN 系统应在过期后自动禁用分享权限
6. WHEN 用户访问知识库 THEN 系统应基于所有权、分享权限、可见性进行权限校验
7. WHEN 进行跨租户访问 THEN 系统应使用资源租户配置而非请求租户配置

### 需求 2: 法律领域专业化

**用户故事**: 作为法律从业者，我希望系统能够理解法律文档的特殊性，提供专业的法律检索、分析和合规功能。

#### 验收标准

1. WHEN 上传法律文档 THEN 系统应自动识别文档类型（法条、判例、合同等）并提取法律元数据
2. WHEN 进行法律检索 THEN 系统应支持按法律领域、司法管辖区、文档类型等专业维度过滤
3. WHEN 查看法律文档 THEN 系统应显示生效日期、权威机构、引用格式等法律专业信息
4. WHEN 分析合同文档 THEN 系统应识别风险点并提供风险等级评估
5. WHEN 检索判例 THEN 系统应支持相似案例匹配和法理提取
6. WHEN 进行合规检查 THEN 系统应根据适用法规自动检查文档合规性
7. WHEN 访问敏感法律信息 THEN 系统应记录详细的合规审计日志
8. WHEN 本地知识库无相关判例 THEN 系统应自动通过AI搜索技术检索裁判文书网等外部数据源
9. WHEN 进行外部判例检索 THEN 系统应支持语义类案搜索并返回高相关性的判例结果

### 需求 3: 多引擎知识图谱集成

**用户故事**: 作为系统管理员，我希望能够根据不同场景选择最适合的知识图谱引擎，以获得最佳的性能和准确性。

#### 验收标准

1. WHEN 配置知识库 THEN 系统应支持选择 aiplusall-kb、GraphRAG、LightRAG 三种图谱引擎
2. WHEN 使用 aiplusall-kb 引擎 THEN 系统应提供快速响应和现有 Neo4j 集成
3. WHEN 使用 GraphRAG 引擎 THEN 系统应支持社区检测和全局查询能力
4. WHEN 使用 LightRAG 引擎 THEN 系统应支持多存储后端和轻量化部署
5. WHEN 切换图谱引擎 THEN 系统应支持数据迁移和平滑切换
6. WHEN 用户私有知识库 THEN 系统应禁用知识图谱功能，仅支持向量和关键词检索
7. WHEN 重建知识图谱 THEN 系统应支持异步批量处理和进度监控

### 需求 4: 资源租户隔离

**用户故事**: 作为系统架构师，我希望系统能够正确处理跨租户共享时的资源归属问题，确保检索和存储的正确性。

#### 验收标准

1. WHEN 创建知识库 THEN 系统应设置 ResourceTenantID 用于资源归属
2. WHEN 进行跨租户检索 THEN 系统应使用资源租户的引擎配置而非请求租户配置
3. WHEN 删除共享知识库 THEN 系统应使用资源租户进行存储配额调整
4. WHEN 统计知识库信息 THEN 系统应基于资源租户进行计算
5. WHEN 访问向量索引 THEN 系统应使用资源租户的向量引擎配置
6. WHEN 操作知识图谱 THEN 系统应使用资源租户的图数据库连接

### 需求 5: API 接口扩展

**用户故事**: 作为前端开发者，我希望有完整的 API 接口支持新的权限模型和法律功能。

#### 验收标准

1. WHEN 调用创建用户私有知识库接口 THEN 系统应提供 POST /api/v1/my/knowledge-bases
2. WHEN 调用知识库列表接口 THEN 系统应返回用户可访问的所有知识库及权限级别
3. WHEN 调用分享管理接口 THEN 系统应支持创建、查询、更新、删除分享记录
4. WHEN 调用法律检索接口 THEN 系统应支持法律专业检索参数
5. WHEN 调用图谱引擎管理接口 THEN 系统应支持引擎切换和配置管理
6. WHEN 调用合规审计接口 THEN 系统应提供详细的访问日志查询

### 需求 6: 数据迁移与兼容

**用户故事**: 作为运维工程师，我希望系统升级过程平滑，不影响现有数据和功能。

#### 验收标准

1. WHEN 执行数据库迁移 THEN 系统应自动为现有知识库添加新字段并设置默认值
2. WHEN 迁移完成后 THEN 现有功能应保持完全兼容
3. WHEN 启用新功能 THEN 系统应通过功能开关控制，支持灰度发布
4. WHEN 回滚升级 THEN 系统应支持安全回滚到之前版本

### 需求 8: 智能外部判例检索

**用户故事**: 作为法律从业者，当本地知识库无法满足我的判例检索需求时，我希望系统能够智能地从裁判文书网等权威外部数据源检索相关判例。

#### 验收标准

1. WHEN 本地知识库检索结果不足 THEN 系统应自动触发外部判例检索
2. WHEN 进行外部判例检索 THEN 系统应支持多种AI搜索引擎（Perplexity.ai、Browser-use等）
3. WHEN 检索裁判文书网 THEN 系统应使用语义理解技术进行类案匹配
4. WHEN 获取外部判例 THEN 系统应自动提取案件要素、争议焦点、裁判要旨等关键信息
5. WHEN 外部检索完成 THEN 系统应将结果与本地检索结果融合排序
6. WHEN 用户选择保存外部判例 THEN 系统应支持一键导入到本地知识库
7. WHEN 外部检索失败 THEN 系统应提供降级方案和错误提示
8. WHEN 进行外部检索 THEN 系统应遵守网站访问规则和频率限制
9. WHEN 实现外部搜索引擎 THEN 系统应扩展现有的 WebSearchProvider 接口，保持架构一致性

### 需求 7: 性能与安全

**用户故事**: 作为系统用户，我希望系统在提供丰富功能的同时，保持高性能和安全性。

#### 验收标准

1. WHEN 进行权限查询 THEN 系统应使用缓存机制，响应时间不超过 100ms
2. WHEN 查询知识库列表 THEN 系统应支持分页和索引优化，支持万级知识库
3. WHEN 访问敏感数据 THEN 系统应记录完整审计日志
4. WHEN 分享权限变更 THEN 系统应及时失效相关缓存
5. WHEN 进行法律检索 THEN 系统应支持复杂查询条件的高效执行
6. WHEN 系统负载较高 THEN 响应时间不应超过正常情况的 3 倍
7. WHEN 进行外部检索 THEN 系统应控制并发请求数量，避免对外部服务造成压力

## 非功能性需求

### 性能需求
- 权限查询响应时间 < 100ms
- 知识库列表查询支持 10,000+ 知识库
- 法律检索响应时间 < 2s
- 图谱重建支持 100,000+ 文档的批量处理

### 安全需求
- 所有敏感操作必须记录审计日志
- 支持数据脱敏和访问控制
- 符合 GDPR 和数据安全法要求
- 分享链接支持过期和撤销机制

### 可用性需求
- 系统可用性 > 99.9%
- 支持灰度发布和快速回滚
- 数据库迁移过程中服务不中断
- 支持多引擎故障切换

### 扩展性需求
- 支持水平扩展到多个租户
- 支持新领域（医疗、金融等）的快速适配
- 支持新的知识图谱引擎集成
- API 接口支持版本兼容

## 约束条件

### 技术约束
- 必须基于现有 Go + Gin + GORM 技术栈
- 必须保持与现有 Neo4j 的兼容性
- 必须支持现有的认证和授权机制
- 数据库迁移必须支持在线执行

### 业务约束
- 不能破坏现有租户隔离的安全性
- 必须保持现有 API 的向后兼容性
- 用户私有知识库不支持知识图谱功能
- 法律功能必须符合相关法规要求

### 时间约束
- 整体项目周期不超过 6 个月
- 每个 Phase 必须有明确的里程碑
- 必须支持分阶段上线和验证

## 验收标准

### 功能验收
- 所有需求的验收标准必须 100% 通过
- 法律专业功能必须通过法律专家验收
- 性能指标必须达到规定要求
- 安全审计必须通过第三方评估

### 技术验收
- 代码覆盖率 > 80%
- 所有 API 接口必须有完整文档
- 数据库设计必须通过 DBA 审核
- 架构设计必须通过技术委员会评审

### 业务验收
- 必须通过用户接受度测试
- 必须完成生产环境部署验证
- 必须完成性能压力测试
- 必须完成安全渗透测试