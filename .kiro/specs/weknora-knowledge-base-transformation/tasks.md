# aiplusall-kb 知识库改造技术规范 - 实施任务

## 概述

本文档将 aiplusall-kb 知识库改造的设计转换为具体的实施任务，按照优先级分为7个阶段：多层权限模型、法律专业化功能、多引擎知识图谱集成、性能优化、安全加固、测试验证和部署上线。

## 实施任务

### Phase 1: 基础架构与数据模型（3-4周）

- [ ] 1. 数据库结构设计与迁移
  - 设计扩展的 KnowledgeBase 表结构，添加 owner_type、owner_tenant_id、owner_user_id、visibility、domain 字段
  - 设计 KnowledgeBaseShare 分享表结构
  - 设计 LegalComplianceAuditLog 审计日志表结构
  - 编写数据库迁移脚本，支持在线执行
  - 为新字段添加必要的数据库索引
  - 执行历史数据回填，设置默认值
  - _需求: 需求 1.1, 1.2, 需求 6.1_

- [ ]* 1.1 编写数据库迁移单元测试
  - 测试迁移脚本的幂等性
  - 测试数据完整性和约束
  - _需求: 需求 6.1, 需求 6.2_

- [ ] 1.2 扩展 Go 数据模型结构体
  - 更新 types.KnowledgeBase 结构体，添加新字段和 JSON 标签
  - 创建 types.KnowledgeBaseShare 结构体
  - 创建 types.LegalDocumentMetadata 结构体和相关枚举
  - 创建 types.LegalComplianceAuditLog 结构体
  - 更新 GORM 模型关系和索引定义
  - _需求: 需求 1.1, 需求 2.1_

- [ ]* 1.3 编写数据模型验证测试
  - 测试结构体字段验证
  - 测试 JSON 序列化/反序列化
  - 测试 GORM 模型关系
  - _需求: 需求 1.1, 需求 2.1_

- [ ] 2. 权限管理核心服务
  - 实现 KnowledgeBasePermissionService 权限计算服务
  - 实现权限级别枚举和优先级逻辑
  - 实现所有者判断逻辑（system/tenant/user）
  - 实现分享权限查询和过期检查
  - 实现权限缓存机制，支持 Redis 缓存
  - 实现缓存失效策略
  - _需求: 需求 1.6, 需求 1.7, 需求 7.1, 需求 7.4_

- [ ]* 2.1 编写权限服务属性测试
  - **属性 1: 权限隔离不变性**
  - **验证需求: 需求 1.6, 1.7**

- [ ]* 2.2 编写权限缓存单元测试
  - 测试缓存命中和失效逻辑
  - 测试并发访问安全性
  - _需求: 需求 7.1, 需求 7.4_

- [ ] 3. Repository 层扩展
  - 实现 KnowledgeBaseShareRepository 接口和实现
  - 扩展 KnowledgeBaseRepository 支持新的查询条件
  - 实现 LegalComplianceAuditLogRepository
  - 优化复杂查询的 SQL 性能
  - 实现分页和排序支持
  - _需求: 需求 1.3, 需求 1.4, 需求 2.7_

- [ ]* 3.1 编写 Repository 集成测试
  - 测试复杂查询的正确性
  - 测试分页和排序功能
  - 测试数据库约束和事务
  - _需求: 需求 1.3, 需求 1.4_

### Phase 2: 多层权限模型实现（4-5周）

- [ ] 4. Handler 层权限校验改造
  - 替换 validateAndGetKnowledgeBase 中的强租户校验为权限校验
  - 更新所有知识库相关的 Handler 方法使用新权限模型
  - 实现权限检查中间件
  - 在请求上下文中设置权限级别和资源租户ID
  - 实现统一的错误处理和响应格式
  - _需求: 需求 1.6, 需求 4.1_

- [ ]* 4.1 编写 Handler 权限校验集成测试
  - 测试不同权限级别的访问控制
  - 测试跨租户访问场景
  - 测试错误处理和响应格式
  - _需求: 需求 1.6, 需求 4.1_

- [ ] 5. Service 层资源租户改造
  - 改造 HybridSearch 使用资源租户配置而非请求租户配置
  - 更新知识库删除逻辑使用资源租户进行存储配额调整
  - 改造统计接口使用资源租户进行计算
  - 实现可访问知识库列表查询，支持复杂的权限过滤
  - 确保所有深度操作使用正确的租户配置
  - _需求: 需求 4.2, 需求 4.3, 需求 4.4, 需求 4.5, 需求 4.6_

- [ ]* 5.1 编写资源租户一致性属性测试
  - **属性 2: 资源租户一致性**
  - **验证需求: 需求 4.2, 4.3, 4.4**

- [ ]* 5.2 编写 Service 层单元测试
  - 测试资源租户配置选择逻辑
  - 测试跨租户检索功能
  - 测试存储配额计算
  - _需求: 需求 4.2, 需求 4.3, 需求 4.4_

- [ ] 6. 用户私有知识库功能
  - 实现 POST /api/v1/my/knowledge-bases 创建用户私有知识库
  - 实现 GET /api/v1/my/knowledge-bases 获取用户私有知识库列表
  - 更新现有知识库接口支持用户私有类型
  - 实现用户私有知识库的特殊权限控制逻辑
  - 确保用户私有知识库不构建知识图谱
  - _需求: 需求 1.3, 需求 5.1, 需求 5.2, 需求 3.6_

- [ ]* 6.1 编写用户私有知识库功能测试
  - 测试创建和查询用户私有知识库
  - 测试权限隔离
  - 测试知识图谱功能禁用
  - _需求: 需求 1.3, 需求 3.6_

- [ ] 7. 分享功能实现
  - 实现 POST /api/v1/knowledge-bases/:id/shares 创建分享
  - 实现 GET /api/v1/knowledge-bases/:id/shares 查询分享列表
  - 实现 PATCH /api/v1/knowledge-bases/:id/shares/:share_id 更新分享
  - 实现 DELETE /api/v1/knowledge-bases/:id/shares/:share_id 删除分享
  - 实现分享过期检查机制和自动清理
  - 实现分享权限验证逻辑
  - _需求: 需求 1.4, 需求 1.5, 需求 5.3, 需求 5.4, 需求 5.5_

- [ ]* 7.1 编写分享权限时效性属性测试
  - **属性 4: 分享权限时效性**
  - **验证需求: 需求 1.5**

- [ ]* 7.2 编写分享功能集成测试
  - 测试分享创建和管理流程
  - 测试权限传递和验证
  - 测试过期机制
  - _需求: 需求 1.4, 需求 1.5_

- [ ] 8. 全局知识库功能
  - 实现 POST /api/v1/system/knowledge-bases 创建全局知识库
  - 设计系统租户或全局配置方案
  - 实现全局知识库的特殊权限控制
  - 确保全局知识库对所有租户可见
  - 实现系统管理员权限验证
  - _需求: 需求 1.1, 需求 1.2, 需求 5.6_

- [ ]* 8.1 编写全局知识库功能测试
  - 测试全局知识库创建和访问
  - 测试系统管理员权限
  - 测试跨租户可见性
  - _需求: 需求 1.1, 需求 1.2_

### Phase 3: 法律专业化功能（5-6周）

- [ ] 9. 法律文档分析核心服务
  - 实现 LegalDocumentAnalyzer 法律文档分析器
  - 实现文档类型自动识别（法条、判例、合同等）
  - 实现法律领域分类（合同法、刑法、民法等）
  - 实现司法管辖区识别
  - 实现关键法律概念提取
  - 实现法条引用解析和提取
  - 实现风险等级评估算法
  - 实现合规检查规则引擎
  - _需求: 需求 2.1, 需求 2.3, 需求 2.4, 需求 2.6_

- [ ]* 9.1 编写法律元数据完整性属性测试
  - **属性 3: 法律元数据完整性**
  - **验证需求: 需求 2.1, 2.3**

- [ ]* 9.2 编写法律文档分析单元测试
  - 测试各种文档类型识别准确性
  - 测试法律概念提取效果
  - 测试风险评估算法
  - _需求: 需求 2.1, 需求 2.4_

- [ ] 10. 法律检索增强服务
  - 实现 LegalSearchEnhancer 法律检索增强器
  - 实现法律专业检索参数支持
  - 实现按法律领域、司法管辖区、文档类型的过滤
  - 实现法律相关性排序算法
  - 实现法条引用和关联推荐
  - 集成到现有的 HybridSearch 服务中
  - _需求: 需求 2.2, 需求 5.4_

- [ ]* 10.1 编写法律检索功能测试
  - 测试法律专业检索参数
  - 测试检索结果相关性
  - 测试性能指标（<2s响应时间）
  - _需求: 需求 2.2, 需求 7.5_

- [ ] 11. 合同智能分析功能
  - 实现合同风险点识别算法
  - 实现合同条款分析和分类
  - 实现风险等级评估和建议生成
  - 实现合同合规性检查
  - 实现 POST /api/v1/legal/contract/analyze 接口
  - 集成到知识文档上传流程中
  - _需求: 需求 2.4, 需求 2.6_

- [ ]* 11.1 编写合同分析功能测试
  - 测试风险识别准确性
  - 测试合规检查效果
  - 测试分析结果格式
  - _需求: 需求 2.4, 需求 2.6_

- [ ] 12. 判例相似度匹配
  - 实现判例相似度计算算法
  - 实现基于事实、争议点、判决结果的多维度匹配
  - 实现法理提取和关键点识别
  - 实现 POST /api/v1/legal/cases/similar 接口
  - 集成到法律检索结果中
  - _需求: 需求 2.5_

- [ ]* 12.1 编写判例匹配功能测试
  - 测试相似度计算准确性
  - 测试多维度匹配效果
  - 测试法理提取质量
  - _需求: 需求 2.5_

- [ ] 13. 法律合规审计增强
  - 扩展现有审计日志支持法律合规字段
  - 实现敏感法律信息访问记录
  - 实现数据分类和敏感度标记
  - 实现合规状态跟踪和报告
  - 实现 GET /api/v1/legal/audit/logs 查询接口
  - 支持按法律领域、敏感度等维度查询
  - _需求: 需求 2.7, 需求 7.3_

- [ ]* 13.1 编写审计日志完整性属性测试
  - **属性 6: 审计日志完整性**
  - **验证需求: 需求 2.7, 需求 7.3**

- [ ]* 13.2 编写法律合规审计测试
  - 测试敏感操作记录完整性
  - 测试合规状态跟踪
  - 测试查询和报告功能
  - _需求: 需求 2.7, 需求 7.3_

- [ ] 14. 外部判例检索核心服务
  - 实现 ExternalCaseSearchService 外部判例检索服务
  - 实现多引擎并行搜索和结果聚合
  - 实现搜索结果缓存机制
  - 实现结果去重和相似度排序算法
  - 实现外部判例导入到本地知识库功能
  - 集成到现有的法律检索流程中
  - 集成现有的 WebSearchService 进行统一管理
  - _需求: 需求 8.1, 需求 8.2, 需求 8.5, 需求 8.6_

- [ ]* 14.1 编写外部搜索结果一致性属性测试
  - **属性 9: 外部搜索结果一致性**
  - **验证需求: 需求 8.3, 8.4, 8.5**

- [ ]* 14.2 编写外部判例检索服务测试
  - 测试多引擎并行搜索功能
  - 测试结果去重和排序算法
  - 测试缓存机制和性能
  - _需求: 需求 8.2, 需求 8.5_

- [ ] 15. Perplexity.ai 法律搜索引擎适配器
  - 在 internal/application/service/web_search 目录下实现 PerplexityLegalProvider
  - 扩展现有的 PerplexityProvider 以支持法律案例搜索
  - 实现与 Perplexity.ai API 的集成，使用法律专业提示词
  - 实现智能搜索提示词构建和 AI 响应解析
  - 实现案例数据提取和相似度评分算法
  - 处理 API 限制和错误重试机制
  - 遵循现有的 WebSearchProvider 接口规范
  - _需求: 需求 8.2, 需求 8.4_

- [ ]* 15.1 编写 Perplexity 法律引擎测试
  - 测试 API 调用和响应解析
  - 测试案例数据提取准确性
  - 测试错误处理和重试机制
  - 测试与现有 WebSearchProvider 接口的兼容性
  - _需求: 需求 8.2, 需求 8.7_

- [ ] 16. Browser-use 搜索引擎适配器
  - 在 internal/application/service/web_search 目录下实现 BrowserUseProvider
  - 实现 WebSearchProvider 接口以保持一致性
  - 实现浏览器自动化脚本调用
  - 实现裁判文书网等网站的数据抓取
  - 实现结构化数据提取和清洗
  - 实现反爬虫机制和访问频率控制
  - 处理网站结构变化的适应性
  - _需求: 需求 8.2, 需求 8.8_

- [ ]* 16.1 编写 Browser-use 引擎测试
  - 测试浏览器自动化功能
  - 测试数据提取准确性
  - 测试访问频率控制
  - 测试 WebSearchProvider 接口实现
  - _需求: 需求 8.2, 需求 8.8_

- [ ] 17. 外部判例检索 API 实现
  - 实现 POST /api/v1/legal/cases/search-external 智能判例搜索接口
  - 实现 POST /api/v1/legal/cases/import-external 外部判例导入接口
  - 实现搜索结果与本地结果的融合排序
  - 实现搜索引擎选择和配置管理
  - 实现搜索历史和缓存管理
  - 集成到现有的法律检索工作流中
  - 利用现有的 WebSearchService 架构进行统一管理
  - _需求: 需求 8.1, 需求 8.6, 需求 5.4_

- [ ]* 17.1 编写外部判例检索 API 测试
  - 测试搜索接口功能和性能
  - 测试导入接口和数据转换
  - 测试结果融合和排序算法
  - _需求: 需求 8.1, 需求 8.6_

### Phase 4: 多引擎知识图谱集成（6-7周）

- [ ] 18. 知识图谱引擎架构设计
  - 设计 KnowledgeGraphEngine 统一接口
  - 实现 GraphEngineManager 引擎管理器
  - 设计引擎注册和发现机制
  - 实现引擎配置管理和验证
  - 设计引擎切换和迁移策略
  - _需求: 需求 3.1, 需求 3.5_

- [ ]* 18.1 编写图谱引擎架构测试
  - 测试引擎注册和发现
  - 测试配置管理
  - 测试接口一致性
  - _需求: 需求 3.1_

- [ ] 19. aiplusall-kb 原生引擎适配器
  - 实现 aiplusall-kbGraphEngine 适配器
  - 集成现有的 Neo4j 图谱构建逻辑
  - 实现现有实体关系抽取功能的封装
  - 保持与现有系统的完全兼容性
  - 实现异步重建和批量处理
  - _需求: 需求 3.2, 需求 3.7_

- [ ]* 19.1 编写 aiplusall-kb 引擎测试
  - 测试与现有功能的兼容性
  - 测试图谱构建和查询
  - 测试异步重建功能
  - _需求: 需求 3.2, 需求 3.7_

- [ ] 20. GraphRAG 引擎适配器
  - 实现 GraphRAGEngine 适配器
  - 集成 Microsoft GraphRAG Python 包
  - 实现社区检测和全局查询功能
  - 实现配置文件生成和管理
  - 实现与 Python 进程的通信机制
  - 处理大规模文档的批量处理
  - _需求: 需求 3.3, 需求 3.7_

- [ ]* 20.1 编写 GraphRAG 引擎测试
  - 测试社区检测功能
  - 测试全局查询能力
  - 测试大规模处理性能
  - _需求: 需求 3.3_

- [ ] 21. LightRAG 引擎适配器
  - 实现 LightRAGEngine 适配器
  - 集成 HKUDS LightRAG 包
  - 实现 LightRAGEngine 适配器
  - 集成 HKUDS LightRAG 包
  - 实现双层检索系统
  - 支持多种存储后端配置
  - 实现轻量化部署和快速响应
  - _需求: 需求 3.4, 需求 3.7_

- [ ]* 21.1 编写 LightRAG 引擎测试
  - 测试双层检索效果
  - 测试多存储后端支持
  - 测试轻量化部署
  - _需求: 需求 3.4_

- [ ] 22. 引擎管理 API 实现
  - 实现 GET /api/v1/graph-engines 获取可用引擎列表
  - 实现 POST /api/v1/knowledge-bases/:id/graph-engine/switch 切换引擎
  - 实现 POST /api/v1/knowledge-bases/:id/graph-engine/rebuild 重建图谱
  - 实现 GET /api/v1/tasks/:id 查询任务状态
  - 实现异步任务管理和进度跟踪
  - _需求: 需求 3.5, 需求 3.7, 需求 5.7_

- [ ]* 22.1 编写引擎管理 API 测试
  - 测试引擎切换流程
  - 测试异步任务管理
  - 测试错误处理和回滚
  - _需求: 需求 3.5, 需求 3.7_

- [ ] 23. 用户私有知识库图谱限制
  - 在知识库创建时检查 OwnerType，禁用用户私有知识库的图谱功能
  - 在图谱相关 API 中添加权限检查
  - 在前端界面中隐藏用户私有知识库的图谱选项
  - 确保用户私有知识库仅使用向量和关键词检索
  - _需求: 需求 3.6_

- [ ]* 23.1 编写图谱引擎隔离性属性测试
  - **属性 5: 图谱引擎隔离性**
  - **验证需求: 需求 3.6**

### Phase 5: 性能优化与缓存（2-3周）

- [ ] 24. 权限查询性能优化
  - 实现 Redis 分布式缓存
  - 优化权限计算算法复杂度
  - 实现权限预计算和批量查询
  - 添加性能监控和指标收集
  - 确保权限查询响应时间 < 100ms
  - _需求: 需求 7.1, 需求 7.4_

- [ ]* 24.1 编写缓存一致性属性测试
  - **属性 8: 缓存一致性**
  - **验证需求: 需求 7.4**

- [ ]* 24.2 编写权限查询性能测试
  - 测试缓存命中率和响应时间
  - 测试并发访问性能
  - 测试缓存失效机制
  - _需求: 需求 7.1, 需求 7.4_

- [ ] 25. 知识库列表查询优化
  - 优化复杂 SQL 查询和 JOIN 操作
  - 添加复合索引和查询计划优化
  - 实现分页查询和游标分页
  - 支持 10,000+ 知识库的高效查询
  - 实现查询结果缓存
  - _需求: 需求 7.2_

- [ ]* 25.1 编写大规模查询性能测试
  - 测试万级知识库查询性能
  - 测试分页和排序效率
  - 测试索引使用效果
  - _需求: 需求 7.2_

- [ ] 26. 法律检索性能优化
  - 优化法律专业检索算法
  - 实现检索结果缓存
  - 优化法律元数据 JSON 字段查询
  - 确保法律检索响应时间 < 2s
  - 实现检索结果预加载
  - _需求: 需求 7.5_

- [ ]* 26.1 编写法律检索性能测试
  - 测试复杂法律查询性能
  - 测试缓存效果
  - 测试并发检索能力
  - _需求: 需求 7.5_

### Phase 6: 安全加固与审计（2-3周）

- [ ] 27. 数据安全与隐私保护
  - 实现敏感数据脱敏和加密
  - 加强跨租户访问控制验证
  - 实现数据访问权限的细粒度控制
  - 添加 SQL 注入和 XSS 防护
  - 实现 API 访问频率限制
  - _需求: 需求 7.3, 需求 7.6_

- [ ]* 27.1 编写安全防护测试
  - 测试权限绕过防护
  - 测试数据泄露防护
  - 测试注入攻击防护
  - _需求: 需求 7.3, 需求 7.6_

- [ ] 28. 合规审计增强
  - 完善审计日志记录范围和详细程度
  - 实现审计日志的完整性验证
  - 添加合规报告生成功能
  - 实现审计日志的安全存储和备份
  - 支持 GDPR 和数据安全法合规要求
  - _需求: 需求 7.3_

- [ ]* 28.1 编写合规审计测试
  - 测试审计日志完整性
  - 测试合规报告准确性
  - 测试数据保护合规性
  - _需求: 需求 7.3_

- [ ] 29. 分享安全机制
  - 实现分享链接的安全令牌机制
  - 添加分享访问的 IP 限制和设备绑定
  - 实现分享操作的二次确认
  - 添加分享异常行为检测和告警
  - 实现分享权限的定期审查
  - _需求: 需求 1.4, 需求 1.5_

- [ ]* 29.1 编写分享安全测试
  - 测试分享令牌安全性
  - 测试访问控制机制
  - 测试异常检测功能
  - _需求: 需求 1.4, 需求 1.5_

### Phase 7: 测试验证与部署（3-4周）

- [ ] 30. 综合功能测试
  - 编写端到端功能测试套件
  - 测试多层权限模型的完整流程
  - 测试法律专业化功能的准确性
  - 测试多引擎图谱集成的稳定性
  - 测试跨租户访问的安全性
  - _需求: 所有功能需求_

- [ ]* 30.1 编写数据迁移幂等性属性测试
  - **属性 7: 数据迁移幂等性**
  - **验证需求: 需求 6.1, 6.2**

- [ ] 31. 性能压力测试
  - 进行大规模并发访问测试
  - 测试系统在高负载下的稳定性
  - 验证所有性能指标达标
  - 进行容量规划和扩展性测试
  - 测试故障恢复和降级机制
  - _需求: 需求 7.1, 需求 7.2, 需求 7.5, 需求 7.6_

- [ ]* 31.1 编写性能基准测试
  - 建立性能基线和监控指标
  - 测试系统容量上限
  - 测试扩展性和弹性
  - _需求: 需求 7.1, 需求 7.2, 需求 7.5_

- [ ] 32. 安全渗透测试
  - 进行权限绕过安全测试
  - 测试跨租户数据泄露防护
  - 进行 SQL 注入和 XSS 测试
  - 测试敏感信息泄露防护
  - 进行 API 安全性测试
  - _需求: 需求 7.3, 需求 7.6_

- [ ]* 32.1 编写安全测试报告
  - 记录安全测试结果
  - 提供安全加固建议
  - 建立安全监控机制
  - _需求: 需求 7.3, 需求 7.6_

- [ ] 33. 生产环境部署准备
  - 准备生产环境配置文件
  - 编写部署脚本和回滚方案
  - 进行灰度发布策略设计
  - 准备监控和告警配置
  - 编写运维文档和故障处理手册
  - _需求: 需求 6.3, 需求 6.4_

- [ ]* 33.1 编写部署验证测试
  - 测试部署脚本正确性
  - 测试回滚机制可靠性
  - 测试监控和告警功能
  - _需求: 需求 6.3, 需求 6.4_

- [ ] 34. 用户接受度测试
  - 组织内部用户进行功能验收
  - 收集用户反馈和改进建议
  - 进行法律专家功能验收
  - 完成业务流程验证
  - 准备用户培训材料
  - _需求: 所有需求的业务验收_

## 检查点

### 检查点 1 - Phase 1 完成后
确保基础架构稳定，数据迁移成功，权限服务正常工作。如有问题请及时反馈。

### 检查点 2 - Phase 2 完成后  
确保多层权限模型完全实现，所有权限测试通过。验证跨租户访问和分享功能正常。

### 检查点 3 - Phase 3 完成后
确保法律专业化功能达到预期效果，法律文档分析准确性满足要求。外部判例检索功能正常工作。

### 检查点 4 - Phase 4 完成后
确保多引擎知识图谱集成稳定，引擎切换功能正常，性能满足要求。

### 检查点 5 - Phase 5-6 完成后
确保系统性能和安全性达标，所有非功能性需求得到满足。

### 检查点 6 - Phase 7 完成后
确保系统通过全面测试，准备好生产环境部署。

## 注意事项

- 标记 `*` 的任务为测试相关任务，可根据项目进度灵活调整
- 每个 Phase 完成后必须进行检查点验证
- 属性测试必须运行至少 100 次迭代以确保可靠性
- 所有 API 接口必须包含完整的错误处理和参数验证
- 数据库操作必须考虑事务一致性和并发安全
- 缓存操作必须考虑一致性和失效策略
- 法律功能必须通过法律专家验收
- 性能指标必须在生产环境中验证
- 外部搜索引擎必须遵守网站访问规则和频率限制