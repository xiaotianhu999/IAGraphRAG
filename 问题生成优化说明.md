# 问题生成优化验证文档

## 修改说明

### 问题背景
用户上传了"中华人民共和国宪法修正案（2018年）.md"，生成的问题为：
```
年宪法修正案对民族关系描述做了哪些修改？
```

**问题**：
1. 标题中的"2018"丢失
2. 文档开头明确有"2018年3月11日"，但也没被捕获

### 根本原因
**上下文窗口限制**：
- 对于文档中后部的分块（如第三十四条），LLM生成问题时只能看到：
  - 前一个分块的后500字符（prevContent）
  - 当前分块内容（content）
  - 后一个分块的前500字符（nextContent）
  - 文档标题（docName）

- **"2018年3月11日"在文档第3行，距离第三十四条太远，不在上下文窗口内**

### 解决方案

#### 1. 提取文档元信息
在 `ProcessQuestionGeneration` 中添加逻辑：
- 扫描文档前2-3个分块
- 查找包含日期的行（如"2018年3月11日"）
- 将这些元信息作为全局上下文传入每个分块的问题生成

```go
// Extract document metadata from first chunks (title, date, etc.)
docMetadata := ""
for i := 0; i < len(textChunks) && i < 3; i++ {
    chunk := textChunks[i]
    if strings.Contains(content, "年") && (strings.Contains(content, "月") || len(content) < 200) {
        // Likely a date/header line
        docMetadata += lines[0]
    }
}
```

#### 2. 优化Prompt
修改 `defaultQuestionGenerationPrompt`：
- 将文档名称单独列出，强调其重要性
- 添加"文档元信息"部分，包含日期等关键标识
- 明确要求："**如果包含年份、日期、版本号，问题中必须包含这些信息**"

#### 3. 修改函数签名
`generateQuestionsWithContext` 新增 `docMetadata` 参数：
```go
func (s *knowledgeService) generateQuestionsWithContext(
    ctx context.Context,
    chatModel chat.Chat, 
    content, prevContent, nextContent, docName, docMetadata string,  // +docMetadata
    questionCount int,
) ([]string, error)
```

### 修改后的Prompt结构

```
你是一个专业的问题生成助手。

## 文档信息（重要）
文档名称：中华人民共和国宪法修正案（2018年）
注意：如果文档名称包含年份、版本号、日期等关键标识，生成的问题中必须保留这些信息！

## 文档元信息（重要：包含日期、版本等关键标识）
2018年3月11日 第十三届全国人民代表大会第一次会议通过

## 上下文信息（仅供参考，帮助理解主要内容）
【前文】第三十三条...
【后文】第三十五条...

## 主要内容（请基于此内容生成问题）
第三十四条 宪法序言第十一自然段中"平等、团结、互助的社会主义民族关系已经确立，并将继续加强。"修改为："平等团结互助和谐的社会主义民族关系已经确立，并将继续加强。"

## 核心要求
- **如果文档名称或上下文中包含年份、日期、版本号等时间标识，问题中必须包含这些信息**
- 问题中禁止使用代词...
```

### 预期效果

**修改前**：
```
年宪法修正案对民族关系描述做了哪些修改？
```

**修改后**：
```
2018年宪法修正案对民族关系描述做了哪些修改？
```

---

## 测试方法

1. 重新启动服务
2. 上传"宪法修正案（2018年）.md"
3. 启用问题生成功能（设置问题数量为3）
4. 等待文档解析完成
5. 查看分块详情中生成的问题
6. 验证问题中是否包含"2018"年份

---

## 影响范围

- **修改文件**：`internal/application/service/knowledge.go`
- **影响功能**：文档问题自动生成
- **向后兼容**：是（新增参数有默认值）
- **需要重新索引**：否（仅影响新上传的文档）

---

## 补充优化建议

### 1. 更智能的元信息提取
当前实现比较简单，可以进一步优化：
```go
// 使用正则表达式匹配日期格式
datePattern := regexp.MustCompile(`\d{4}年\d{1,2}月\d{1,2}日`)
versionPattern := regexp.MustCompile(`第.+届|版本|修订`)
```

### 2. 文档类型识别
不同类型文档的元信息位置不同：
- 法律文档：通常在开头2-3行
- 技术文档：可能在README或首页
- 学术论文：在摘要或标题页

### 3. 配置化
允许用户在知识库设置中配置是否提取元信息：
```yaml
question_generation:
  use_doc_metadata: true  # 是否使用文档元信息
  metadata_lines: 3       # 扫描前N个分块
```

---

**修改日期**：2026-01-03  
**修改人**：GitHub Copilot  
**版本**：v1.0
