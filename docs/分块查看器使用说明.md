# 文本分块查看器 (ChunkViewer) 使用说明

## 功能概述

文本分块查看器是一个全新的可视化工具，用于详细查看和分析知识库文档的文本分块情况。

## 功能特性

### 📊 统计概览
- **总分块数**：显示文档被分割成多少个文本块
- **平均长度**：每个分块的平均字符数
- **含图片分块数**：包含图片信息的分块数量

### 🔍 分块详情
每个分块显示以下信息：
- **序号和ID**：分块的索引位置和唯一标识符
- **内容长度**：字符数统计
- **分块类型**：text（文本）、image_ocr（图片OCR）等
- **分块内容**：完整的文本内容，支持展开/收起
- **图片信息**：如果包含图片，显示图片预览、描述和OCR文本
- **位置信息**：在原文档中的字符位置范围 [start-end]
- **导航链接**：跳转到上一个或下一个分块
- **启用状态**：分块是否被启用
- **创建时间**：分块的创建时间戳

### 🎨 交互功能
- **展开/收起**：点击按钮查看或隐藏分块详情
- **复制内容**：一键复制分块文本内容
- **图片预览**：点击图片可在弹窗中放大查看
- **搜索**：（即将推出）搜索特定分块内容
- **分页导航**：支持大量分块的分页浏览

## 使用方法

### 访问分块查看器

1. 打开知识库页面
2. 点击任意文档查看详情
3. 在文档详情页面，点击**"详细分析"**按钮
4. 系统会切换到分块查看器模式

### 视图模式切换

文档详情页面提供三种视图模式：

1. **分块视图**（默认）：传统的分块列表视图
2. **详细分析视图**：新的分块查看器，提供详细的统计和分析
3. **原文件视图**：查看原始文件内容（仅支持文本文件）

点击**"切换视图"**按钮可在三种模式间循环切换。

## 技术实现

### 前端组件
- **文件位置**：`frontend/src/views/knowledge/components/ChunkViewer.vue`
- **集成位置**：`frontend/src/components/doc-content.vue`

### API 接口
- **获取分块列表**：`GET /api/v1/chunks/{knowledge_id}?page=1&page_size=20`
- **返回数据**：
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "chunk-uuid",
        "content": "分块内容",
        "chunk_index": 0,
        "chunk_type": "text",
        "start_at": 0,
        "end_at": 500,
        "pre_chunk_id": "",
        "next_chunk_id": "next-chunk-uuid",
        "is_enabled": true,
        "image_info": "[...]",
        "created_at": "2025-12-31T15:00:00Z"
      }
    ],
    "total": 23,
    "page": 1,
    "page_size": 20
  }
  ```

### 样式设计
- 使用渐变色卡片展示统计数据
- 响应式布局，适配不同屏幕尺寸
- 悬停效果和平滑过渡动画
- 明暗交替的分块项，便于区分

## 调试和监控

### 后端日志

上传文档时，后端会输出详细的分块日志：

```
INFO [DocReader] ========== 解析结果概览 ==========
INFO [DocReader] 知识ID: xxx, 知识库ID: xxx
INFO [DocReader] 总Chunk数量: 23
INFO [DocReader] 包含图片的Chunk数: 5, 总图片数: 7
INFO [DocReader] Chunk #0 (seq=0): 内容长度=456, 图片数=0, 范围=[0-456]
INFO [DocReader]   图片 #0: URL=xxx
INFO [DocReader] ========== 解析结果概览结束 ==========
```

### 查看日志位置
- **容器环境**：`docker logs <container-name>`
- **本地开发**：控制台输出

## 故障排查

### 常见问题

1. **分块列表为空**
   - 检查文档是否已完成处理（parse_status = "completed"）
   - 查看后端日志确认分块是否成功创建

2. **图片无法显示**
   - 确认图片URL可访问
   - 检查CORS设置
   - 验证COS/MinIO配置

3. **性能问题**
   - 调整分页大小（默认20条/页）
   - 对于大文档，避免全部展开所有分块

## 未来改进

- [ ] 实现分块内容搜索功能
- [ ] 添加分块质量评分
- [ ] 支持分块编辑和重新生成
- [ ] 导出分块数据为CSV/JSON
- [ ] 可视化分块分布图表
- [ ] 分块相似度分析

## 贡献

欢迎提交问题和改进建议！

---

**更新时间**：2025-12-31  
**版本**：v1.0.0
