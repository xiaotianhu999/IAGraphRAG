# 权限漏洞修复说明

## 修复日期
2025-12-30

## 问题描述
发现严重的权限绕过漏洞：普通用户只有"对话"权限时，点击聊天输入框中的"前往设置"链接，可以直接访问设置界面。关闭设置界面后，原本没有权限的"用户管理"、"审计日志"等菜单都异常出现了。

### 漏洞根因分析
1. **导航处理器缺陷**：`Input-field.vue` 中的 `handleGoToAgentSettings()` 和 `handleGoToWebSearchSettings()` 函数直接调用 `router.push()` 跳转到设置页面，没有进行任何权限检查
2. **路由守卫不完整**：路由守卫只检查了 `requiresSuperAdmin` 和 `requiresAdmin` 角色权限，但没有验证普通用户的 `menu_config` 权限
3. **路由元数据缺失**：Settings 和 Knowledge Bases 路由没有 `requiresMenuPermission` 元数据，导致无法进行菜单权限检查
4. **菜单状态腐败**：用户通过未授权路径访问设置后，菜单状态可能被错误地重新初始化，导致显示了不应该看到的菜单项

## 修复方案

### 1. 导航处理器权限检查 (Input-field.vue)

#### 1.1 引入 authStore
```typescript
import { useAuthStore } from '@/stores/auth';
const authStore = useAuthStore();
```

#### 1.2 添加权限检查计算属性
```typescript
// 检查用户是否有设置权限
const hasSettingsPermission = computed(() => {
  const userMenuConfig = authStore.user?.menu_config || []
  return authStore.isAdmin || userMenuConfig.includes('settings')
})
```

#### 1.3 修改 handleGoToAgentSettings
```typescript
const handleGoToAgentSettings = () => {
  // 检查用户是否有settings权限
  const userMenuConfig = authStore.user?.menu_config || []
  const hasSettingsPermission = authStore.isAdmin || userMenuConfig.includes('settings')
  
  if (!hasSettingsPermission) {
    MessagePlugin.warning('您没有访问设置的权限')
    return
  }
  
  uiStore.openSettings('agent');
  if (route.path !== '/platform/settings') {
    router.push('/platform/settings');
  }
}
```

#### 1.4 修改 handleGoToWebSearchSettings
```typescript
const handleGoToWebSearchSettings = () => {
  // 检查用户是否有settings权限
  const userMenuConfig = authStore.user?.menu_config || []
  const hasSettingsPermission = authStore.isAdmin || userMenuConfig.includes('settings')
  
  if (!hasSettingsPermission) {
    MessagePlugin.warning('您没有访问设置的权限')
    return
  }
  
  uiStore.openSettings('websearch');
  if (route.path !== '/platform/settings') {
    router.push('/platform/settings');
  }
}
```

#### 1.5 模板条件显示
```vue
<!-- 只有有权限的用户才显示"前往设置"链接 -->
<div v-if="!settingsStore.isAgentReady && !isAgentEnabled && hasSettingsPermission" class="agent-mode-footer">
  <a href="#" @click.prevent="handleGoToAgentSettings" class="agent-mode-link">
    {{ $t('input.goToSettings') }}
  </a>
</div>
```

### 2. 路由守卫增强 (router/index.ts)

#### 2.1 为路由添加权限元数据
```typescript
{
  path: "settings",
  name: "settings",
  component: () => import("../views/settings/Settings.vue"),
  meta: { 
    requiresInit: true, 
    requiresAuth: true, 
    requiresMenuPermission: 'settings'  // 新增
  }
},
{
  path: "knowledge-bases",
  name: "knowledgeBaseList",
  component: () => import("../views/knowledge/KnowledgeBaseList.vue"),
  meta: { 
    requiresInit: true, 
    requiresAuth: true, 
    requiresMenuPermission: 'knowledge-bases'  // 新增
  }
}
```

#### 2.2 路由守卫添加菜单权限检查
```typescript
router.beforeEach(async (to, from, next) => {
  // ... 现有的检查代码 ...

  // 检查管理员权限 (超级管理员或租户管理员)
  if (to.meta.requiresAdmin && !authStore.isAdmin) {
    next('/platform/knowledge-bases')
    return
  }

  // 新增：检查菜单权限（针对普通用户）
  if (to.meta.requiresMenuPermission && !authStore.isAdmin) {
    const menuConfig = authStore.user?.menu_config || []
    const requiredPermission = to.meta.requiresMenuPermission as string
    
    if (!menuConfig.includes(requiredPermission)) {
      console.warn(`User lacks menu permission: ${requiredPermission}`)
      // 重定向到用户有权限的默认页面
      next('/platform/creatChat')
      return
    }
  }

  // ... 后续代码 ...
})
```

#### 2.3 添加路由切换后的菜单配置保护
```typescript
// 路由切换后确保菜单配置正确
router.afterEach(() => {
  const authStore = useAuthStore()
  if (authStore.isLoggedIn) {
    authStore.ensureMenuConfig()
  }
})
```

### 3. Auth Store 增强 (stores/auth.ts)

#### 3.1 添加 ensureMenuConfig 方法
```typescript
const ensureMenuConfig = () => {
  if (!user.value) return
  
  const menuStore = useMenuStore()
  const effectiveMenuConfig = (user.value.menu_config && user.value.menu_config.length > 0) 
    ? user.value.menu_config 
    : (tenant.value?.menu_config || [])
  menuStore.setMenuConfig(effectiveMenuConfig, canAccessAllTenants.value, user.value.role)
}
```

#### 3.2 导出新方法
```typescript
return {
  // ... 现有导出 ...
  ensureMenuConfig,  // 新增
  // ... 其他方法 ...
}
```

## 修复效果

### 安全性提升
1. ✅ **导航拦截**：所有通过代码导航到受保护页面的操作都会进行权限验证
2. ✅ **路由保护**：通过 URL 直接访问受保护页面会被路由守卫拦截
3. ✅ **UI隐藏**：没有权限的用户看不到"前往设置"等跳转链接
4. ✅ **菜单保护**：路由切换后自动确保菜单配置正确，防止状态腐败

### 用户体验
1. 无权限用户点击受保护链接时，会显示友好的提示信息："您没有访问设置的权限"
2. 通过 URL 直接访问时，会自动重定向到有权限的默认页面（对话页）
3. 管理员不受影响，依然可以正常访问所有功能

### 防护层级
实现了三层防护机制：

1. **第一层：UI层防护**
   - 通过 `hasSettingsPermission` 计算属性控制链接显示
   - 无权限用户看不到跳转入口

2. **第二层：代码导航防护**
   - `handleGoToAgentSettings()` 和 `handleGoToWebSearchSettings()` 进行权限检查
   - 拒绝未授权的导航请求

3. **第三层：路由守卫防护**
   - 路由守卫检查 `requiresMenuPermission` 元数据
   - 拦截所有未授权的路由访问
   - 包括直接修改 URL 的情况

4. **第四层：菜单状态保护**
   - `router.afterEach` 钩子确保菜单配置始终正确
   - 防止菜单状态在路由切换后被错误重置

## 测试建议

### 测试场景 1：普通用户通过 UI 访问设置
1. 使用只有 "creatChat" 权限的普通用户登录
2. 尝试在聊天输入框中点击"前往设置"
3. **预期结果**：看不到"前往设置"链接（UI 已隐藏）

### 测试场景 2：普通用户通过代码导航访问设置
1. 假设某处代码仍然触发了 `handleGoToAgentSettings()`
2. **预期结果**：显示"您没有访问设置的权限"提示，不会跳转

### 测试场景 3：普通用户直接访问 URL
1. 使用只有 "creatChat" 权限的普通用户登录
2. 在浏览器地址栏直接输入 `/platform/settings`
3. **预期结果**：自动重定向到 `/platform/creatChat`，控制台输出警告

### 测试场景 4：菜单状态保护
1. 使用只有 "creatChat" 权限的普通用户登录
2. 尝试各种方式访问设置页面（应该都被拦截）
3. 返回对话页面，检查左侧菜单
4. **预期结果**：只显示"AI对话"菜单项，不显示其他菜单

### 测试场景 5：管理员正常使用
1. 使用管理员账号登录
2. 点击"前往设置"链接
3. **预期结果**：正常跳转到设置页面，功能不受影响

### 测试场景 6：权限变更后的状态同步
1. 管理员为某用户添加 "settings" 权限
2. 该用户刷新页面或重新登录
3. **预期结果**：可以看到"前往设置"链接，可以正常访问设置页面

## 相关文件
- `frontend/src/components/Input-field.vue` - 导航处理器权限检查
- `frontend/src/router/index.ts` - 路由守卫和元数据
- `frontend/src/stores/auth.ts` - 菜单配置保护方法

## 后续建议
1. 对所有其他可能的导航处理函数进行审计，确保都有权限检查
2. 考虑为所有受保护的路由添加 `requiresMenuPermission` 元数据
3. 添加自动化测试，覆盖权限绕过场景
4. 定期进行安全审计，检查是否有新的权限漏洞引入
