# WeKnora é…ç½®ä¸€è‡´æ€§å…¨é¢åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**ï¼š2025-12-31  
**åˆ†æèŒƒå›´**ï¼šconfig.yaml ä¸æ•°æ®åº“é…ç½®çš„ä¸€è‡´æ€§  
**ç›®æ ‡**ï¼šè¯†åˆ«é™¤çŸ¥è¯†å›¾è°±ã€åˆ†å—é…ç½®å¤–çš„å…¶ä»–é…ç½®ä¸ä¸€è‡´é—®é¢˜

---

## ä¸€ã€é…ç½®æ¶æ„æ€»è§ˆ

### 1.1 é…ç½®å±‚çº§å…³ç³»

```
config.yaml (åº”ç”¨çº§é»˜è®¤é…ç½®)
    â†“
knowledge_bases è¡¨ (çŸ¥è¯†åº“çº§é…ç½®ï¼ŒJSONå­—æ®µ)
    â†“
å®é™…è¿è¡Œæ—¶ä½¿ç”¨çš„é…ç½®
```

### 1.2 config.yaml ä¸­ knowledge_base é…ç½®æ®µ

**æ–‡ä»¶ä½ç½®**ï¼š`config/config.yaml` (ç¬¬730è¡Œå¼€å§‹)

```yaml
knowledge_base:
  # åˆ†å—é…ç½®
  chunk_size: 1000
  chunk_overlap: 200
  split_markers: [...]
  
  # å›¾åƒå¤„ç†é…ç½®
  image_processing:
    enable_multimodal: true
```

### 1.3 æ•°æ®åº“ KnowledgeBase ç»“æ„

**æ–‡ä»¶ä½ç½®**ï¼š`internal/types/knowledgebase.go`

```go
type KnowledgeBase struct {
    // åˆ†å—é…ç½® (JSONå­—æ®µ)
    ChunkingConfig ChunkingConfig `gorm:"type:json"`
    
    // å›¾åƒå¤„ç†é…ç½® (JSONå­—æ®µ)
    ImageProcessingConfig ImageProcessingConfig `gorm:"type:json"`
    
    // Embeddingæ¨¡å‹ID (varcharå­—æ®µ)
    EmbeddingModelID string
    
    // æ‘˜è¦æ¨¡å‹ID (varcharå­—æ®µ)
    SummaryModelID string
    
    // VLMé…ç½® (JSONå­—æ®µ)
    VLMConfig VLMConfig `gorm:"type:json"`
    
    // å­˜å‚¨é…ç½® (JSONå­—æ®µ)
    StorageConfig StorageConfig `gorm:"column:cos_config;type:json"`
    
    // æŠ½å–é…ç½® (JSONå­—æ®µ)
    ExtractConfig *ExtractConfig `gorm:"column:extract_config;type:json"`
    
    // FAQé…ç½® (JSONå­—æ®µ)
    FAQConfig *FAQConfig `gorm:"column:faq_config;type:json"`
    
    // é—®é¢˜ç”Ÿæˆé…ç½® (JSONå­—æ®µ)
    QuestionGenerationConfig *QuestionGenerationConfig `gorm:"type:json"`
}
```

---

## äºŒã€é…ç½®é¡¹è¯¦ç»†åˆ†æ

### 2.1 åˆ†å—é…ç½® (ChunkingConfig) âœ… å·²è§£å†³

**config.yaml ä½ç½®**ï¼š
```yaml
knowledge_base:
  chunk_size: 1000
  chunk_overlap: 200
  split_markers: [...]
```

**æ•°æ®åº“å­—æ®µ**ï¼š`chunking_config` (JSON)

**ä¸€è‡´æ€§çŠ¶æ€**ï¼šâœ… **å·²è§£å†³**

**è§£å†³æ–¹æ¡ˆ**ï¼šå·²å®ç° `EnsureChunkingDefaults()` æ–¹æ³•ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨å¡«å……ç©ºå€¼å­—æ®µ

**ä¼˜å…ˆçº§**ï¼šå·²å®Œæˆ

---

### 2.2 å›¾åƒå¤„ç†é…ç½® (ImageProcessingConfig) âš ï¸ å­˜åœ¨é—®é¢˜

**config.yaml ä½ç½®**ï¼š
```yaml
knowledge_base:
  image_processing:
    enable_multimodal: true
```

**æ•°æ®åº“å­—æ®µ**ï¼š`image_processing_config` (JSON)

```go
type ImageProcessingConfig struct {
    ModelID string `yaml:"model_id" json:"model_id"`
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **é…ç½®é¡¹ä¸åŒ¹é…**ï¼š
   - config.yaml å®šä¹‰ï¼š`enable_multimodal: bool`
   - æ•°æ®åº“å®šä¹‰ï¼š`ModelID: string`
   - **ä¸¤è€…å®Œå…¨ä¸ä¸€è‡´ï¼**

2. **å†å²å…¼å®¹æ€§é—®é¢˜**ï¼š
   - æ—§ç‰ˆæœ¬ï¼š`ChunkingConfig.EnableMultimodal` (bool)
   - æ–°ç‰ˆæœ¬ï¼š`VLMConfig.Enabled` + `VLMConfig.ModelID`
   - ä¸­é—´è¿‡æ¸¡ï¼š`ImageProcessingConfig.ModelID`

3. **å®é™…ä½¿ç”¨**ï¼š
   ```go
   // ä»£ç ä¸­åˆ¤æ–­å¤šæ¨¡æ€æ˜¯å¦å¯ç”¨
   func (kb *KnowledgeBase) IsMultimodalEnabled() bool {
       if kb.VLMConfig.IsEnabled() {
           return true  // æ–°ç‰ˆæœ¬
       }
       if kb.ChunkingConfig.EnableMultimodal {
           return true  // è€ç‰ˆæœ¬å…¼å®¹
       }
       return false
   }
   ```

**å­˜åœ¨çš„ä¸ä¸€è‡´**ï¼š
- âŒ config.yaml çš„ `enable_multimodal` æ— æ³•æ˜ å°„åˆ°æ•°æ®åº“å­—æ®µ
- âŒ æ–°å»ºçŸ¥è¯†åº“æ—¶ï¼Œconfig.yaml çš„é…ç½®ä¸ä¼šè¢«ä½¿ç”¨
- âŒ å‰ç«¯æ— æ³•è·çŸ¥å…¨å±€é»˜è®¤çš„å¤šæ¨¡æ€é…ç½®

**å½±å“èŒƒå›´**ï¼š
- æ–°å»ºçŸ¥è¯†åº“æ—¶å¿…é¡»æ‰‹åŠ¨æŒ‡å®š VLM é…ç½®
- æ— æ³•é€šè¿‡ config.yaml ç»Ÿä¸€ç®¡ç†å¤šæ¨¡æ€é»˜è®¤è®¾ç½®
- å†å²æ•°æ®å…¼å®¹æ€§æ··ä¹±

**ä¼˜å…ˆçº§**ï¼šğŸ”´ **P1 - é«˜ä¼˜å…ˆçº§**

---

### 2.3 Embedding æ¨¡å‹é…ç½® âš ï¸ å­˜åœ¨é—®é¢˜

**config.yaml**ï¼š**ä¸å­˜åœ¨å…¨å±€é»˜è®¤é…ç½®**

**æ•°æ®åº“å­—æ®µ**ï¼š`embedding_model_id` (varchar)

**é—®é¢˜åˆ†æ**ï¼š

1. **ç¼ºå°‘å…¨å±€é»˜è®¤å€¼**ï¼š
   - config.yaml ä¸­æ²¡æœ‰ `default_embedding_model_id` é…ç½®
   - æ–°å»ºçŸ¥è¯†åº“æ—¶å¿…é¡»å‰ç«¯æä¾› embedding_model_id
   - æ— æ³•ç»Ÿä¸€ç®¡ç†é»˜è®¤ embedding æ¨¡å‹

2. **å½“å‰è¡Œä¸º**ï¼š
   ```go
   func (s *knowledgeBaseService) CreateKnowledgeBase(ctx context.Context, kb *types.KnowledgeBase) {
       // æ²¡æœ‰å¡«å…… embedding_model_id é»˜è®¤å€¼
       // å®Œå…¨ä¾èµ–å‰ç«¯ä¼ å…¥
   }
   ```

3. **æ½œåœ¨é—®é¢˜**ï¼š
   - å‰ç«¯å¿˜è®°ä¼ å…¥ â†’ çŸ¥è¯†åº“æ— æ³•æ­£å¸¸å·¥ä½œ
   - ä¿®æ”¹é»˜è®¤æ¨¡å‹éœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç 
   - ä¸åŒçŸ¥è¯†åº“å¯èƒ½ä½¿ç”¨ä¸åŒæ¨¡å‹ï¼Œå¯¼è‡´å‘é‡ä¸å…¼å®¹

**å­˜åœ¨çš„ä¸ä¸€è‡´**ï¼š
- âŒ æ— å…¨å±€é»˜è®¤é…ç½®
- âŒ æ— è‡ªåŠ¨å¡«å……æœºåˆ¶
- âŒ å‰ç«¯å¿…é¡»ç¡¬ç¼–ç é»˜è®¤å€¼

**å½±å“èŒƒå›´**ï¼š
- æ–°å»ºçŸ¥è¯†åº“å®¹æ˜“é—æ¼é…ç½®
- æ— æ³•ç»Ÿä¸€ç®¡ç†å’Œæ›´æ–°é»˜è®¤æ¨¡å‹
- å‘é‡å…¼å®¹æ€§é£é™©

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **P2 - ä¸­ä¼˜å…ˆçº§**

---

### 2.4 æ‘˜è¦æ¨¡å‹é…ç½® âš ï¸ å­˜åœ¨é—®é¢˜

**config.yaml**ï¼š**ä¸å­˜åœ¨å…¨å±€é»˜è®¤é…ç½®**

**æ•°æ®åº“å­—æ®µ**ï¼š`summary_model_id` (varchar)

**é—®é¢˜åˆ†æ**ï¼šä¸ Embedding æ¨¡å‹é…ç½®é—®é¢˜ç›¸åŒ

**å­˜åœ¨çš„ä¸ä¸€è‡´**ï¼š
- âŒ æ— å…¨å±€é»˜è®¤é…ç½®
- âŒ æ— è‡ªåŠ¨å¡«å……æœºåˆ¶
- âŒ å‰ç«¯å¿…é¡»ç¡¬ç¼–ç é»˜è®¤å€¼

**å½±å“èŒƒå›´**ï¼š
- æ–‡æ¡£æ‘˜è¦åŠŸèƒ½å¯èƒ½ç¼ºå¤±é…ç½®
- æ— æ³•ç»Ÿä¸€ç®¡ç†æ‘˜è¦æ¨¡å‹

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **P2 - ä¸­ä¼˜å…ˆçº§**

---

### 2.5 VLM é…ç½® (VLMConfig) âš ï¸ å­˜åœ¨é—®é¢˜

**config.yaml**ï¼š**ä¸å­˜åœ¨å…¨å±€é»˜è®¤é…ç½®**

**æ•°æ®åº“å­—æ®µ**ï¼š`vlm_config` (JSON)

```go
type VLMConfig struct {
    Enabled   bool   `json:"enabled"`
    ModelID   string `json:"model_id"`
    // è€ç‰ˆæœ¬å…¼å®¹å­—æ®µ
    ModelName string `json:"model_name,omitempty"`
    BaseURL   string `json:"base_url,omitempty"`
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **ç¼ºå°‘å…¨å±€é»˜è®¤å€¼**ï¼š
   - config.yaml ä¸­æ²¡æœ‰ `vlm` é…ç½®æ®µ
   - æ— æ³•ç»Ÿä¸€ç®¡ç† VLM é»˜è®¤è®¾ç½®

2. **ä¸ ImageProcessingConfig çš„å…³ç³»æ··ä¹±**ï¼š
   - config.yaml æœ‰ `image_processing.enable_multimodal`
   - ä½†å®é™…ä½¿ç”¨çš„æ˜¯ `VLMConfig.Enabled`
   - ä¸¤è€…è¯­ä¹‰é‡å ä½†ä¸åŒæ­¥

3. **å†å²å…¼å®¹æ€§è´Ÿæ‹…**ï¼š
   - åŒæ—¶æ”¯æŒ `model_id` (æ–°) å’Œ `model_name/base_url` (è€)
   - åˆ¤æ–­é€»è¾‘å¤æ‚

**å­˜åœ¨çš„ä¸ä¸€è‡´**ï¼š
- âŒ config.yaml é…ç½®é¡¹åç§°ä¸å®é™…ä½¿ç”¨ä¸ä¸€è‡´
- âŒ æ— å…¨å±€é»˜è®¤ VLM é…ç½®
- âŒ ä¸ image_processing é…ç½®è¯­ä¹‰é‡å 

**å½±å“èŒƒå›´**ï¼š
- å¤šæ¨¡æ€åŠŸèƒ½é…ç½®æ··ä¹±
- å‰ç«¯éš¾ä»¥ç†è§£é…ç½®é€»è¾‘

**ä¼˜å…ˆçº§**ï¼šğŸŸ¡ **P2 - ä¸­ä¼˜å…ˆçº§**

---

### 2.6 å­˜å‚¨é…ç½® (StorageConfig) âœ… æ— é—®é¢˜

**config.yaml**ï¼š**ä¸å­˜åœ¨å…¨å±€é»˜è®¤é…ç½®**

**æ•°æ®åº“å­—æ®µ**ï¼š`cos_config` (JSON)

```go
type StorageConfig struct {
    SecretID   string
    SecretKey  string
    Region     string
    BucketName string
    AppID      string
    PathPrefix string
    Provider   string
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **ç§Ÿæˆ·çº§é…ç½®æ›´åˆç†**ï¼š
   - å­˜å‚¨é…ç½®é€šå¸¸æ˜¯ç§Ÿæˆ·çº§åˆ«çš„ï¼Œä¸åº”è¯¥æ˜¯çŸ¥è¯†åº“çº§åˆ«
   - å½“å‰æ¶æ„å…è®¸æ¯ä¸ªçŸ¥è¯†åº“ä½¿ç”¨ä¸åŒå­˜å‚¨ï¼Œè¿‡äºçµæ´»åè€Œä¸åˆ©äºç®¡ç†

2. **å½“å‰è¡Œä¸º**ï¼š
   - å®Œå…¨ç”±å‰ç«¯æä¾›é…ç½®
   - æ²¡æœ‰é»˜è®¤å€¼å¡«å……

**ä¸€è‡´æ€§çŠ¶æ€**ï¼šâœ… **è®¾è®¡åˆç†ï¼Œæ— éœ€é»˜è®¤å€¼**

**è¯´æ˜**ï¼šå­˜å‚¨é…ç½®åº”è¯¥æ˜¯ç§Ÿæˆ·é…ç½®ï¼Œä¸éœ€è¦çŸ¥è¯†åº“çº§åˆ«çš„é»˜è®¤å€¼

**ä¼˜å…ˆçº§**ï¼šä½ï¼ˆå»ºè®®æœªæ¥è¿ç§»åˆ°ç§Ÿæˆ·é…ç½®ï¼‰

---

### 2.7 æŠ½å–é…ç½® (ExtractConfig) âœ… å·²è§£å†³

**config.yaml ä½ç½®**ï¼š
```yaml
extract:
  extract_graph:
    description: |
      # çŸ¥è¯†å›¾è°±æŠ½å– prompt
    tags:
      - "å±äº"
      - "è§£é‡Š"
      # ...
```

**æ•°æ®åº“å­—æ®µ**ï¼š`extract_config` (JSON)

```go
type ExtractConfig struct {
    Enabled   bool             `json:"enabled"`
    Text      string           `json:"text,omitempty"`
    Tags      []string         `json:"tags,omitempty"`
    Nodes     []*GraphNode     `json:"nodes,omitempty"`
    Relations []*GraphRelation `json:"relations,omitempty"`
}
```

**ä¸€è‡´æ€§çŠ¶æ€**ï¼šâœ… **å·²æœ‰å¡«å……é€»è¾‘**

**å½“å‰å®ç°**ï¼š
- config.yaml ä½œä¸ºå…¨å±€é»˜è®¤é…ç½®
- å‰ç«¯å¯ä»¥è¦†ç›–
- å·²æœ‰é€»è¾‘å¤„ç†ç©ºå€¼å¡«å……

**ä¼˜å…ˆçº§**ï¼šå·²å®Œæˆ

---

### 2.8 FAQ é…ç½® (FAQConfig) âœ… å·²è§£å†³

**config.yaml**ï¼š**ä¸éœ€è¦å…¨å±€é»˜è®¤é…ç½®**ï¼ˆåªæœ‰FAQç±»å‹çŸ¥è¯†åº“éœ€è¦ï¼‰

**æ•°æ®åº“å­—æ®µ**ï¼š`faq_config` (JSON)

```go
type FAQConfig struct {
    IndexMode         FAQIndexMode         // question_only | question_answer
    QuestionIndexMode FAQQuestionIndexMode // combined | separate
}
```

**ä¸€è‡´æ€§çŠ¶æ€**ï¼šâœ… **å·²æœ‰ EnsureDefaults() å¤„ç†**

```go
func (kb *KnowledgeBase) EnsureDefaults() {
    if kb.Type == KnowledgeBaseTypeFAQ {
        if kb.FAQConfig == nil {
            kb.FAQConfig = &FAQConfig{
                IndexMode:         FAQIndexModeQuestionAnswer,
                QuestionIndexMode: FAQQuestionIndexModeCombined,
            }
        }
    }
}
```

**ä¼˜å…ˆçº§**ï¼šå·²å®Œæˆ

---

### 2.9 é—®é¢˜ç”Ÿæˆé…ç½® (QuestionGenerationConfig) âš ï¸ å­˜åœ¨é—®é¢˜

**config.yaml**ï¼š**ä¸å­˜åœ¨å…¨å±€é»˜è®¤é…ç½®**

**æ•°æ®åº“å­—æ®µ**ï¼š`question_generation_config` (JSON)

```go
type QuestionGenerationConfig struct {
    Enabled       bool `json:"enabled"`
    QuestionCount int  `json:"question_count"` // é»˜è®¤3ï¼Œæœ€å¤§10
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **ç¼ºå°‘å…¨å±€é»˜è®¤å€¼**ï¼š
   - config.yaml ä¸­æ²¡æœ‰æ­¤é…ç½®æ®µ
   - æ— æ³•ç»Ÿä¸€æ§åˆ¶æ˜¯å¦é»˜è®¤å¯ç”¨é—®é¢˜ç”Ÿæˆ

2. **prompt å­˜åœ¨ä½†é…ç½®ä¸å­˜åœ¨**ï¼š
   - config.yaml æœ‰ `generate_questions_prompt` (promptæ¨¡æ¿)
   - ä½†æ²¡æœ‰å¯¹åº”çš„é…ç½®ï¼ˆå¯ç”¨çŠ¶æ€ã€é—®é¢˜æ•°é‡ç­‰ï¼‰

**å­˜åœ¨çš„ä¸ä¸€è‡´**ï¼š
- âŒ æœ‰ prompt æ¨¡æ¿ä½†æ— é…ç½®é¡¹
- âŒ æ— å…¨å±€é»˜è®¤å€¼
- âŒ å‰ç«¯å¿…é¡»è‡ªè¡Œå†³å®šæ˜¯å¦å¯ç”¨

**å½±å“èŒƒå›´**ï¼š
- é—®é¢˜ç”ŸæˆåŠŸèƒ½éš¾ä»¥ç»Ÿä¸€ç®¡ç†
- æ–°çŸ¥è¯†åº“å¯èƒ½é—æ¼é…ç½®

**ä¼˜å…ˆçº§**ï¼šğŸŸ¢ **P3 - ä½ä¼˜å…ˆçº§**

---

## ä¸‰ã€é…ç½®ä¸€è‡´æ€§é—®é¢˜æ±‡æ€»

### 3.1 é—®é¢˜åˆ†ç±»

| é…ç½®é¡¹ | config.yaml | æ•°æ®åº“å­—æ®µ | ä¸€è‡´æ€§çŠ¶æ€ | ä¼˜å…ˆçº§ |
|--------|-------------|-----------|-----------|--------|
| **åˆ†å—é…ç½®** | âœ… å®Œæ•´ | chunking_config | âœ… å·²è§£å†³ | - |
| **å›¾åƒå¤„ç†** | âš ï¸ è¿‡æ—¶ | image_processing_config | âŒ ç»“æ„ä¸åŒ¹é… | ğŸ”´ P1 |
| **Embeddingæ¨¡å‹** | âŒ ç¼ºå¤± | embedding_model_id | âŒ æ— é»˜è®¤å€¼ | ğŸŸ¡ P2 |
| **æ‘˜è¦æ¨¡å‹** | âŒ ç¼ºå¤± | summary_model_id | âŒ æ— é»˜è®¤å€¼ | ğŸŸ¡ P2 |
| **VLMé…ç½®** | âš ï¸ è¯­ä¹‰æ··ä¹± | vlm_config | âŒ æ˜ å°„é”™è¯¯ | ğŸŸ¡ P2 |
| **å­˜å‚¨é…ç½®** | âŒ ç¼ºå¤± | cos_config | âœ… è®¾è®¡åˆç† | - |
| **æŠ½å–é…ç½®** | âœ… å®Œæ•´ | extract_config | âœ… å·²å¤„ç† | - |
| **FAQé…ç½®** | N/A | faq_config | âœ… å·²å¤„ç† | - |
| **é—®é¢˜ç”Ÿæˆ** | âš ï¸ éƒ¨åˆ† | question_generation_config | âŒ æ— é»˜è®¤å€¼ | ğŸŸ¢ P3 |

---

### 3.2 ä¸¥é‡ç¨‹åº¦åˆ†çº§

#### ğŸ”´ P1 - é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“åŠŸèƒ½æ­£ç¡®æ€§ï¼‰

**1. å›¾åƒå¤„ç†é…ç½®ä¸ä¸€è‡´**
- **é—®é¢˜**ï¼šconfig.yaml å’Œæ•°æ®åº“ç»“æ„å®Œå…¨ä¸åŒ¹é…
- **å½±å“**ï¼šå¤šæ¨¡æ€é…ç½®æ··ä¹±ï¼Œç”¨æˆ·éš¾ä»¥ç†è§£
- **ä¿®å¤éš¾åº¦**ï¼šä¸­ç­‰ï¼ˆéœ€è¦ç»Ÿä¸€é…ç½®ç»“æ„ï¼‰

---

#### ğŸŸ¡ P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆå½±å“æ˜“ç”¨æ€§ï¼‰

**2. Embedding æ¨¡å‹ç¼ºå°‘é»˜è®¤å€¼**
- **é—®é¢˜**ï¼šæ— æ³•ç»Ÿä¸€ç®¡ç†é»˜è®¤ embedding æ¨¡å‹
- **å½±å“**ï¼šå‰ç«¯å¿…é¡»ç¡¬ç¼–ç ï¼Œä¿®æ”¹ä¸ä¾¿
- **ä¿®å¤éš¾åº¦**ï¼šä½ï¼ˆæ·»åŠ é…ç½®é¡¹ + å¡«å……é€»è¾‘ï¼‰

**3. æ‘˜è¦æ¨¡å‹ç¼ºå°‘é»˜è®¤å€¼**
- **é—®é¢˜**ï¼šæ— æ³•ç»Ÿä¸€ç®¡ç†é»˜è®¤æ‘˜è¦æ¨¡å‹
- **å½±å“**ï¼šä¸ Embedding æ¨¡å‹é—®é¢˜ç›¸åŒ
- **ä¿®å¤éš¾åº¦**ï¼šä½

**4. VLM é…ç½®è¯­ä¹‰æ··ä¹±**
- **é—®é¢˜**ï¼šä¸ image_processing é…ç½®é‡å 
- **å½±å“**ï¼šé…ç½®é€»è¾‘ä¸æ¸…æ™°
- **ä¿®å¤éš¾åº¦**ï¼šä¸­ç­‰ï¼ˆéœ€è¦ç»Ÿä¸€é…ç½®è¯­ä¹‰ï¼‰

---

#### ğŸŸ¢ P3 - ä½ä¼˜å…ˆçº§ï¼ˆå½±å“ç®¡ç†ä¾¿åˆ©æ€§ï¼‰

**5. é—®é¢˜ç”Ÿæˆé…ç½®ç¼ºå¤±**
- **é—®é¢˜**ï¼šæœ‰ prompt æ¨¡æ¿ä½†æ— é…ç½®é¡¹
- **å½±å“**ï¼šæ— æ³•ç»Ÿä¸€æ§åˆ¶é—®é¢˜ç”ŸæˆåŠŸèƒ½
- **ä¿®å¤éš¾åº¦**ï¼šä½

---

## å››ã€è§£å†³æ–¹æ¡ˆå»ºè®®

### 4.1 ã€P1ã€‘å›¾åƒå¤„ç†é…ç½®ç»Ÿä¸€æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šåºŸå¼ƒ image_processingï¼Œç»Ÿä¸€ä½¿ç”¨ VLM é…ç½®ï¼ˆæ¨èï¼‰

**1. ä¿®æ”¹ config.yaml**ï¼š
```yaml
knowledge_base:
  # åˆ é™¤æ—§é…ç½®
  # image_processing:
  #   enable_multimodal: true
  
  # æ–°å¢ VLM é»˜è®¤é…ç½®
  vlm:
    enabled: true           # æ˜¯å¦é»˜è®¤å¯ç”¨å¤šæ¨¡æ€
    model_id: ""            # é»˜è®¤ VLM æ¨¡å‹IDï¼ˆç©ºè¡¨ç¤ºä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼‰
```

**2. ä¿®æ”¹ config.go**ï¼š
```go
type KnowledgeBaseConfig struct {
    // ...
    // åˆ é™¤
    // ImageProcessing *ImageProcessingConfig
    
    // æ–°å¢
    VLM *VLMDefaultConfig `yaml:"vlm" json:"vlm"`
}

type VLMDefaultConfig struct {
    Enabled bool   `yaml:"enabled" json:"enabled"`
    ModelID string `yaml:"model_id" json:"model_id"`
}
```

**3. æ·»åŠ  EnsureVLMDefaults() æ–¹æ³•**ï¼š
```go
// internal/types/knowledgebase.go
func (kb *KnowledgeBase) EnsureVLMDefaults(defaultConfig *config.VLMDefaultConfig) {
    if kb == nil || defaultConfig == nil {
        return
    }
    
    // å¦‚æœå®Œå…¨æ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
    if !kb.VLMConfig.Enabled && kb.VLMConfig.ModelID == "" && 
       kb.VLMConfig.ModelName == "" && kb.VLMConfig.BaseURL == "" {
        kb.VLMConfig.Enabled = defaultConfig.Enabled
        kb.VLMConfig.ModelID = defaultConfig.ModelID
    }
}
```

**4. ä¿®æ”¹æœåŠ¡å±‚**ï¼š
```go
// internal/application/service/knowledgebase.go
func (s *knowledgeBaseService) CreateKnowledgeBase(ctx context.Context, kb *types.KnowledgeBase) {
    // ... åŸæœ‰é€»è¾‘
    
    // å¡«å…… VLM é»˜è®¤é…ç½®
    if s.config.KnowledgeBase.VLM != nil {
        kb.EnsureVLMDefaults(s.config.KnowledgeBase.VLM)
    }
    
    // ...
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»Ÿä¸€é…ç½®è¯­ä¹‰
- âœ… æ¸…æ™°çš„é»˜è®¤å€¼ç®¡ç†
- âœ… å‰ç«¯å¯ä»¥è¦†ç›–

**è¿ç§»è®¡åˆ’**ï¼š
1. æ·»åŠ æ–°é…ç½®ï¼Œä¿æŒå‘åå…¼å®¹
2. å‰ç«¯é€æ­¥è¿ç§»åˆ°æ–°é…ç½®
3. 1-2ä¸ªç‰ˆæœ¬ååºŸå¼ƒæ—§é…ç½®

---

### 4.2 ã€P2ã€‘æ·»åŠ æ¨¡å‹é»˜è®¤é…ç½®

#### ä¿®æ”¹ config.yaml

```yaml
knowledge_base:
  # æ–°å¢ï¼šé»˜è®¤ embedding æ¨¡å‹
  default_embedding_model_id: "text-embedding-3-small"
  
  # æ–°å¢ï¼šé»˜è®¤æ‘˜è¦æ¨¡å‹
  default_summary_model_id: "gpt-4o-mini"
  
  # ... åŸæœ‰é…ç½®
```

#### ä¿®æ”¹ config.go

```go
type KnowledgeBaseConfig struct {
    // ... åŸæœ‰å­—æ®µ
    
    // æ–°å¢
    DefaultEmbeddingModelID string `yaml:"default_embedding_model_id" json:"default_embedding_model_id"`
    DefaultSummaryModelID   string `yaml:"default_summary_model_id"   json:"default_summary_model_id"`
}
```

#### æ·»åŠ å¡«å……é€»è¾‘

```go
// internal/types/knowledgebase.go
func (kb *KnowledgeBase) EnsureModelDefaults(config *config.KnowledgeBaseConfig) {
    if kb == nil || config == nil {
        return
    }
    
    // å¡«å…… Embedding æ¨¡å‹é»˜è®¤å€¼
    if kb.EmbeddingModelID == "" && config.DefaultEmbeddingModelID != "" {
        kb.EmbeddingModelID = config.DefaultEmbeddingModelID
    }
    
    // å¡«å……æ‘˜è¦æ¨¡å‹é»˜è®¤å€¼
    if kb.SummaryModelID == "" && config.DefaultSummaryModelID != "" {
        kb.SummaryModelID = config.DefaultSummaryModelID
    }
}
```

#### ä¿®æ”¹æœåŠ¡å±‚

```go
func (s *knowledgeBaseService) CreateKnowledgeBase(ctx context.Context, kb *types.KnowledgeBase) {
    // ... åŸæœ‰é€»è¾‘
    
    kb.EnsureDefaults()
    kb.EnsureChunkingDefaults(defaultChunkingConfig)
    
    // æ–°å¢ï¼šå¡«å……æ¨¡å‹é»˜è®¤å€¼
    kb.EnsureModelDefaults(s.config.KnowledgeBase)
    
    // ...
}

func (s *knowledgeBaseService) GetKnowledgeBaseByID(ctx context.Context, id string) {
    // ... åŸæœ‰é€»è¾‘
    
    kb.EnsureDefaults()
    kb.EnsureChunkingDefaults(defaultChunkingConfig)
    
    // æ–°å¢ï¼šå¡«å……æ¨¡å‹é»˜è®¤å€¼
    kb.EnsureModelDefaults(s.config.KnowledgeBase)
    
    // ...
}
```

---

### 4.3 ã€P3ã€‘æ·»åŠ é—®é¢˜ç”Ÿæˆé»˜è®¤é…ç½®

#### ä¿®æ”¹ config.yaml

```yaml
knowledge_base:
  # æ–°å¢ï¼šé—®é¢˜ç”Ÿæˆé»˜è®¤é…ç½®
  question_generation:
    enabled: false        # æ˜¯å¦é»˜è®¤å¯ç”¨
    question_count: 3     # é»˜è®¤ç”Ÿæˆé—®é¢˜æ•°é‡
```

#### ä¿®æ”¹ config.go

```go
type KnowledgeBaseConfig struct {
    // ... åŸæœ‰å­—æ®µ
    
    // æ–°å¢
    QuestionGeneration *QuestionGenerationDefaultConfig `yaml:"question_generation" json:"question_generation"`
}

type QuestionGenerationDefaultConfig struct {
    Enabled       bool `yaml:"enabled"        json:"enabled"`
    QuestionCount int  `yaml:"question_count" json:"question_count"`
}
```

#### æ·»åŠ å¡«å……é€»è¾‘

```go
func (kb *KnowledgeBase) EnsureQuestionGenerationDefaults(config *config.QuestionGenerationDefaultConfig) {
    if kb == nil || config == nil || kb.Type != KnowledgeBaseTypeDocument {
        return
    }
    
    if kb.QuestionGenerationConfig == nil {
        kb.QuestionGenerationConfig = &QuestionGenerationConfig{
            Enabled:       config.Enabled,
            QuestionCount: config.QuestionCount,
        }
        return
    }
    
    // å¡«å……é»˜è®¤é—®é¢˜æ•°é‡
    if kb.QuestionGenerationConfig.QuestionCount == 0 {
        kb.QuestionGenerationConfig.QuestionCount = config.QuestionCount
    }
}
```

---

## äº”ã€å®Œæ•´å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šP1 é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼ˆ1-2å¤©ï¼‰

- [ ] ç»Ÿä¸€ VLM é…ç½®ç»“æ„
- [ ] åºŸå¼ƒ image_processing é…ç½®
- [ ] æ·»åŠ  EnsureVLMDefaults() æ–¹æ³•
- [ ] æ›´æ–°æœåŠ¡å±‚è°ƒç”¨
- [ ] æµ‹è¯•å¤šæ¨¡æ€åŠŸèƒ½

### é˜¶æ®µ 2ï¼šP2 ä¸­ä¼˜å…ˆçº§ä¿®å¤ï¼ˆ1å¤©ï¼‰

- [ ] æ·»åŠ  default_embedding_model_id é…ç½®
- [ ] æ·»åŠ  default_summary_model_id é…ç½®
- [ ] å®ç° EnsureModelDefaults() æ–¹æ³•
- [ ] æ›´æ–°æœåŠ¡å±‚è°ƒç”¨
- [ ] æµ‹è¯•æ–°å»ºçŸ¥è¯†åº“

### é˜¶æ®µ 3ï¼šP3 ä½ä¼˜å…ˆçº§ä¼˜åŒ–ï¼ˆ0.5å¤©ï¼‰

- [ ] æ·»åŠ  question_generation é…ç½®æ®µ
- [ ] å®ç° EnsureQuestionGenerationDefaults() æ–¹æ³•
- [ ] æ›´æ–°æœåŠ¡å±‚è°ƒç”¨

### é˜¶æ®µ 4ï¼šæ–‡æ¡£ä¸æµ‹è¯•ï¼ˆ0.5å¤©ï¼‰

- [ ] æ›´æ–°é…ç½®æ–‡æ¡£
- [ ] æ·»åŠ é…ç½®é¡¹è¯´æ˜
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] å‰ç«¯é€‚é…æŒ‡å—

---

## å…­ã€é…ç½®ä¼˜å…ˆçº§è§„åˆ™ï¼ˆç»Ÿä¸€æ ‡å‡†ï¼‰

### ä¼˜å…ˆçº§é¡ºåº

```
æ•°æ®åº“æ˜¾å¼é…ç½® > config.yaml é»˜è®¤å€¼ > ä»£ç ç¡¬ç¼–ç é»˜è®¤å€¼
```

### å¡«å……é€»è¾‘ç»Ÿä¸€æ¨¡å¼

```go
func (kb *KnowledgeBase) Ensure<ConfigName>Defaults(defaultConfig *<ConfigType>) {
    if kb == nil || defaultConfig == nil {
        return
    }
    
    // 1. å®Œå…¨ä¸ºç©º â†’ ä½¿ç”¨å…¨å±€é»˜è®¤
    if <å®Œå…¨ä¸ºç©ºåˆ¤æ–­> {
        kb.<ConfigField> = *defaultConfig
        return
    }
    
    // 2. éƒ¨åˆ†ä¸ºç©º â†’ å¡«å……ç©ºå­—æ®µ
    if kb.<ConfigField>.<SubField1> == <é›¶å€¼> {
        kb.<ConfigField>.<SubField1> = defaultConfig.<SubField1>
    }
    if kb.<ConfigField>.<SubField2> == <é›¶å€¼> {
        kb.<ConfigField>.<SubField2> = defaultConfig.<SubField2>
    }
    // ...
}
```

### æœåŠ¡å±‚è°ƒç”¨ç»Ÿä¸€ä½ç½®

```go
func (s *knowledgeBaseService) CreateKnowledgeBase(ctx, kb) {
    // 1. ç±»å‹é»˜è®¤å€¼
    kb.EnsureDefaults()
    
    // 2. åˆ†å—é…ç½®é»˜è®¤å€¼
    kb.EnsureChunkingDefaults(defaultChunkingConfig)
    
    // 3. VLM é…ç½®é»˜è®¤å€¼
    kb.EnsureVLMDefaults(s.config.KnowledgeBase.VLM)
    
    // 4. æ¨¡å‹é…ç½®é»˜è®¤å€¼
    kb.EnsureModelDefaults(s.config.KnowledgeBase)
    
    // 5. é—®é¢˜ç”Ÿæˆé…ç½®é»˜è®¤å€¼
    kb.EnsureQuestionGenerationDefaults(s.config.KnowledgeBase.QuestionGeneration)
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    s.repo.CreateKnowledgeBase(ctx, kb)
}

func (s *knowledgeBaseService) GetKnowledgeBaseByID(ctx, id) {
    kb := s.repo.GetKnowledgeBaseByID(ctx, id)
    
    // åŒæ ·çš„å¡«å……é€»è¾‘ï¼ˆç¡®ä¿å†å²æ•°æ®ä¹Ÿèƒ½è·å¾—é»˜è®¤å€¼ï¼‰
    kb.EnsureDefaults()
    kb.EnsureChunkingDefaults(defaultChunkingConfig)
    kb.EnsureVLMDefaults(s.config.KnowledgeBase.VLM)
    kb.EnsureModelDefaults(s.config.KnowledgeBase)
    kb.EnsureQuestionGenerationDefaults(s.config.KnowledgeBase.QuestionGeneration)
    
    return kb
}
```

---

## ä¸ƒã€æ€»ç»“

### å½“å‰çŠ¶æ€

- âœ… **å·²è§£å†³**ï¼šåˆ†å—é…ç½®ã€FAQé…ç½®ã€æŠ½å–é…ç½®
- âŒ **å¾…è§£å†³**ï¼šå›¾åƒ/VLMé…ç½®ã€æ¨¡å‹é…ç½®ã€é—®é¢˜ç”Ÿæˆé…ç½®

### æ ¸å¿ƒé—®é¢˜

1. **é…ç½®ç»“æ„ä¸åŒ¹é…**ï¼šconfig.yaml ä¸æ•°æ®åº“å­—æ®µè¯­ä¹‰ä¸ä¸€è‡´
2. **ç¼ºå°‘é»˜è®¤å€¼**ï¼šå…³é”®é…ç½®é¡¹æ— å…¨å±€é»˜è®¤å€¼
3. **å†å²å…¼å®¹æ€§è´Ÿæ‹…**ï¼šå¤šç‰ˆæœ¬é…ç½®å…±å­˜ï¼Œé€»è¾‘æ··ä¹±

### è§£å†³æ–¹å‘

1. **ç»Ÿä¸€é…ç½®è¯­ä¹‰**ï¼šconfig.yaml é…ç½®é¡¹åº”ä¸æ•°æ®åº“å­—æ®µä¸€ä¸€å¯¹åº”
2. **å®Œå–„é»˜è®¤å€¼ç³»ç»Ÿ**ï¼šæ‰€æœ‰å¯é…ç½®é¡¹éƒ½åº”æœ‰åˆç†é»˜è®¤å€¼
3. **è¿è¡Œæ—¶è‡ªåŠ¨å¡«å……**ï¼šè¯»å–/åˆ›å»ºæ—¶è‡ªåŠ¨å¡«å……ç©ºå€¼å­—æ®µ
4. **ä¿æŒå‘åå…¼å®¹**ï¼šé€æ­¥è¿ç§»ï¼Œä¸ç ´åå†å²æ•°æ®

### é¢„æœŸæ”¶ç›Š

- âœ… å‰ç«¯å¼€å‘æ›´ç®€å•ï¼ˆæ— éœ€ç¡¬ç¼–ç é»˜è®¤å€¼ï¼‰
- âœ… é…ç½®ç®¡ç†æ›´ç»Ÿä¸€ï¼ˆé€šè¿‡ config.yaml é›†ä¸­ç®¡ç†ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆæ–°å»ºçŸ¥è¯†åº“è‡ªåŠ¨ä½¿ç”¨æœ€ä¼˜é…ç½®ï¼‰
- âœ… ç³»ç»Ÿç»´æŠ¤æ›´æ–¹ä¾¿ï¼ˆä¿®æ”¹é»˜è®¤å€¼æ— éœ€ä¿®æ”¹ä»£ç ï¼‰

---

**æœ€åæ›´æ–°**ï¼š2025-12-31  
**ç‰ˆæœ¬**ï¼šv1.0
